flowchart TD
    DSL["Layer line (e.g., Conv2D(...) @ \"cuda:0\")"] --> Grammar{"?layer"}
    Grammar -->|basic_layer first| Basic
    Basic --> LT["Extract layer_type, params, device_spec, block"]
    LT --> VD{"Device prefix valid? (cpu/cuda/gpu/tpu/xla)"}
    VD -->|yes| Dispatch["layer_type_map -> method (e.g., conv2d)"]
    VD -->|no| Err["DSLValidationError: invalid device"]
    Dispatch --> Build{"conv2d()/dense()/... returns {type, params, sublayers}"}
    Build --> SetDev["Attach device if provided"]
    SetDev --> Out["Layer dict"]

